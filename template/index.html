<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fake Scholarship Detection System</title>
    <link rel="stylesheet" type="text/css" href="{{url_for('static',filename='styles.css')}}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üîç Scholarship Shield</h1>
            <p>Protect yourself from fake scholarship scams using AI-powered detection</p>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalChecked">0</div>
                <div class="stat-label">URLs Analyzed</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="scamsDetected">0</div>
                <div class="stat-label">Scams Detected</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="safeScholarships">0</div>
                <div class="stat-label">Safe Scholarships</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="accuracyRate">0%</div>
                <div class="stat-label">Accuracy Rate</div>
            </div>
        </div>

        <div class="alert alert-success" id="successAlert"></div>
        <div class="alert alert-error" id="errorAlert"></div>

        <div class="main-content">
            <div class="card">
                <h2>üîó Single URL Analysis</h2>
                <form id="singleUrlForm">
                    <div class="input-group">
                        <label for="scholarshipUrl">Scholarship URL</label>
                        <input type="url" id="scholarshipUrl" placeholder="https://example.com/scholarship" required>
                    </div>
                    <button type="submit" class="btn" id="analyzeBtn">
                        Analyze Scholarship
                    </button>
                </form>
            </div>

            <div class="card">
                <h2>üìù Text Analysis</h2>
                <form id="textAnalysisForm">
                    <div class="input-group">
                        <label for="scholarshipText">Scholarship Description</label>
                        <textarea id="scholarshipText" placeholder="Paste the scholarship description here..." required></textarea>
                    </div>
                    <button type="submit" class="btn" id="analyzeTextBtn">
                        Analyze Text
                    </button>
                </form>
            </div>
        </div>

        <div class="card">
            <h2>üìä Batch Analysis</h2>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('urls')">Multiple URLs</button>
                <button class="tab" onclick="switchTab('upload')">Upload File</button>
            </div>
            
            <div class="tab-content active" id="urls-content">
                <form id="batchUrlForm">
                    <div class="input-group">
                        <label for="batchUrls">Multiple URLs (one per line)</label>
                        <textarea id="batchUrls" placeholder="https://example1.com/scholarship&#10;https://example2.com/scholarship&#10;https://example3.com/scholarship" rows="6"></textarea>
                    </div>
                    <button type="submit" class="btn" id="batchAnalyzeBtn">
                        Analyze All URLs
                    </button>
                </form>
            </div>
            
            <div class="tab-content" id="upload-content">
                <div class="input-group">
                    <label for="fileUpload">Upload CSV/TXT file with URLs</label>
                    <input type="file" id="fileUpload" accept=".csv,.txt">
                </div>
                <button type="button" class="btn" id="uploadAnalyzeBtn" onclick="handleFileUpload()">
                    Analyze Uploaded File
                </button>
            </div>
        </div>

        <div class="card">
            <h2>üìÅ Analysis History</h2>
            <div id="historyResults"></div>
        </div>


        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p>Analyzing scholarship data...</p>
        </div>

        <div class="results-section" id="resultsSection" style="display: none;">
            <h2>üìã Analysis Results</h2>
            <div id="resultsContainer"></div>
        </div>

        <div class="card">
            <h2>üìä Analytics Dashboard</h2>
            <canvas id="scamChart">Scam Chart</canvas>
            <br>
            <canvas id="accuracyChart">Accuracy Chart</canvas>
            <br>
            <canvas id="domainChart"> Domain Chart</canvas>
        </div>


        <div class="card">
            <h2>‚ÑπÔ∏è How It Works</h2>
            <ul class="feature-list">
                <li>Advanced NLP analysis of scholarship descriptions</li>
                <li>Domain reputation and age verification</li>
                <li>Suspicious keyword and phrase detection</li>
                <li>Grammar and language pattern analysis</li>
                <li>Machine learning classification (BERT model)</li>
                <li>Real-time scam probability scoring</li>
                <li>Batch processing for multiple URLs</li>
                <li>Detailed risk assessment reports</li>
            </ul>
        </div>
    </div>

    <script>
        

        
        // Global variables
        let analysisStats = {
            totalChecked: 0,
            scamsDetected: 0,
            safeScholarships: 0
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            loadStoredStats();
        });

        function initializeEventListeners() {
            document.getElementById('singleUrlForm').addEventListener('submit', handleSingleUrlAnalysis);
            document.getElementById('textAnalysisForm').addEventListener('submit', handleTextAnalysis);
            document.getElementById('batchUrlForm').addEventListener('submit', handleBatchAnalysis);
            document.getElementById('uploadAnalyzeBtn').addEventListener('click', handleFileUpload);
        }

        function switchTab(tabName) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            event.target.classList.add('active');
            document.getElementById(tabName + '-content').classList.add('active');
        }

        async function handleSingleUrlAnalysis(event) {
            event.preventDefault();
            const url = document.getElementById('scholarshipUrl').value;
            const button = document.getElementById('analyzeBtn');
            
            if (!url) {
                showAlert('Please enter a valid URL', 'error');
                return;
            }

            setLoadingState(button, true);
            showLoading(true);

            try {
                const result = await analyzeScholarship(url);
                displayResults([result]);
                updateStats(result);
                showAlert('Analysis completed successfully!', 'success');
            } catch (error) {
                showAlert('Error analyzing scholarship: ' + error.message, 'error');
            } finally {
                setLoadingState(button, false);
                showLoading(false);
            }
        }

        async function handleTextAnalysis(event) {
            event.preventDefault();
            const text = document.getElementById('scholarshipText').value;
            const button = document.getElementById('analyzeTextBtn');
            
            if (!text.trim()) {
                showAlert('Please enter scholarship text to analyze', 'error');
                return;
            }

            setLoadingState(button, true);
            showLoading(true);

            try {
                const result = await analyzeText(text);
                displayResults([result]);
                updateStats(result);
                showAlert('Text analysis completed successfully!', 'success');
            } catch (error) {
                showAlert('Error analyzing text: ' + error.message, 'error');
            } finally {
                setLoadingState(button, false);
                showLoading(false);
            }
        }

        async function handleBatchAnalysis(event) {
            event.preventDefault();
            const urlsText = document.getElementById('batchUrls').value;
            const button = document.getElementById('batchAnalyzeBtn');
            
            if (!urlsText.trim()) {
                showAlert('Please enter URLs to analyze', 'error');
                return;
            }

            const urls = urlsText.split('\n').filter(url => url.trim());
            if (urls.length === 0) {
                showAlert('No valid URLs found', 'error');
                return;
            }

            setLoadingState(button, true);
            showLoading(true);

            try {
                const results = await Promise.all(urls.map(url => analyzeScholarship(url.trim())));
                displayResults(results);
                results.forEach(result => updateStats(result));
                showAlert(`Batch analysis completed! Analyzed ${results.length} URLs.`, 'success');
            } catch (error) {
                showAlert('Error in batch analysis: ' + error.message, 'error');
            } finally {
                setLoadingState(button, false);
                showLoading(false);
            }
        }


        async function handleFileUpload() {
            const fileInput = document.getElementById('fileUpload');
            const file = fileInput.files[0];

            if (!file) {
                showAlert('Please select a file to upload', 'error');
                return;
            }

            // ‚úÖ Add this file type check here
            const allowedTypes = [
                'text/plain',
                'text/csv',
                // 'application/pdf',
                // 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
            ];
            if (!allowedTypes.includes(file.type)) {
                showAlert('Only TXT, CSV files are supported.', 'error');
                return;
            }

            const button = document.getElementById('uploadAnalyzeBtn');
            setLoadingState(button, true);
            showLoading(true);

            try {
                const text = await readFile(file);  // This works for TXT/CSV; PDF/DOCX should be handled server-side.
                const urls = text.split('\n').filter(url => url.trim());

                if (urls.length === 0) {
                    showAlert('No valid URLs found in file', 'error');
                    return;
                }

                const results = await Promise.all(urls.map(url => analyzeScholarship(url.trim())));
                displayResults(results);
                results.forEach(result => updateStats(result));
                showAlert(`File analysis completed! Analyzed ${results.length} URLs.`, 'success');
            } catch (error) {
                showAlert('Error processing file: ' + error.message, 'error');
            } finally {
                setLoadingState(button, false);
                showLoading(false);
            }
        }



        async function analyzeScholarship(url) {
            const response = await fetch('/api/analyze-url', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to analyze URL');
            }

            const data = await response.json();
            return {
                url: data.url,
                scamProbability: data.scam_probability,
                isScam: data.is_scam,
                riskLevel: data.risk_level,
                details: {
                    suspiciousKeywords: data.details.suspicious_keywords,
                    domainAge: data.details.domain_age,
                    grammarScore: data.details.grammar_score,
                    legitimacyIndicators: data.details.legitimacy_indicators
                },
                timestamp: data.timestamp
            };
        }

        async function analyzeText(text) {
            const response = await fetch('/api/analyze-text', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to analyze text');
            }

            const data = await response.json();
            return {
                url: data.url,
                text: data.text,
                scamProbability: data.scam_probability,
                isScam: data.is_scam,
                riskLevel: data.risk_level,
                details: {
                    suspiciousKeywords: data.details.suspicious_keywords,
                    sentimentScore: data.details.sentiment_score,
                    grammarScore: data.details.grammar_score,
                    readabilityScore: data.details.readability_score
                },
                timestamp: data.timestamp
            };
        }


        function displayResults(results) {
            const container = document.getElementById('resultsContainer');
            const section = document.getElementById('resultsSection');
            
            container.innerHTML = '';
            
            results.forEach(result => {
                const resultElement = createResultElement(result);
                container.appendChild(resultElement);
            });
            
            section.style.display = 'block';
            section.scrollIntoView({ behavior: 'smooth' });
        }

        // function createResultElement(result) {
        //     const div = document.createElement('div');
        //     div.className = 'result-item';
            
        //     const riskClass = result.riskLevel === 'high' ? 'danger' : 
        //                     result.riskLevel === 'medium' ? 'warning' : 'safe';
            
        //     const percentage = Math.round(result.scamProbability * 100);
        //     const localTime = new Date(result.timestamp).toLocaleString('en-LK', { timeZone: 'Asia/Colombo' });

        //     div.innerHTML = `
        //         <div class="result-header">
        //             <div class="result-url">${result.url}</div>
        //             <div class="probability-badge ${riskClass}">
        //                 ${percentage}% Risk
        //             </div>
        //         </div>
        //         <div class="progress-bar">
        //             <div class="progress-fill" style="width: ${percentage}%; background: ${
        //                 result.riskLevel === 'high' ? '#dc3545' : 
        //                 result.riskLevel === 'medium' ? '#ffc107' : '#28a745'
        //             }"></div>
        //         </div>
        //         <div class="result-details">
        //             <strong>Risk Level:</strong> ${result.riskLevel.toUpperCase()}<br>
        //             <strong>Suspicious Keywords:</strong> ${result.details.suspiciousKeywords.join(', ') || 'None detected'}<br>
        //             ${result.details.domainAge ? `<strong>Domain Age:</strong> ${result.details.domainAge}<br>` : ''}
        //             <strong>Grammar Score:</strong> ${result.details.grammarScore}/100<br>
        //             <strong>Analysis Time:</strong> ${localTime}

        //         </div>
        //         <div class="feedback-buttons">
        //             <button onclick="sendFeedback('${result.url}', ${result.isScam}, true)">üëç Correct</button>
        //             <button onclick="sendFeedback('${result.url}', ${result.isScam}, false)">üëé Wrong</button>
        //         </div>

        //     `;
            
        //     return div;
        // }
        function createResultElement(result) {
            const div = document.createElement('div');
            div.className = 'result-item';

            const riskClass = result.riskLevel === 'high' ? 'danger' :
                            result.riskLevel === 'medium' ? 'warning' : 'safe';
            const percentage = Math.round(result.scamProbability * 100);
            const localTime = new Date(result.timestamp).toLocaleString('en-LK', { timeZone: 'Asia/Colombo' });

            div.innerHTML = `
                <div class="result-header">
                    <div class="result-url">${result.url || 'Text Analysis'}</div>
                    <div class="probability-badge ${riskClass}">
                        ${percentage}% Risk
                    </div>
                </div>
                <div class="progress-bar">
                     <div class="progress-fill" style="width: ${percentage}%; background: ${
                         result.riskLevel === 'high' ? '#dc3545' : 
                         result.riskLevel === 'medium' ? '#ffc107' : '#28a745'
                     }"></div>
                </div>
                <div class="result-details">
                    <strong>Risk Level:</strong> ${result.riskLevel?.toUpperCase() || '-'}<br>
                    <strong>Suspicious Keywords:</strong> ${(result.details?.suspiciousKeywords || []).join(', ') || 'None detected'}<br>
                    ${result.details?.domainAge ? `<strong>Domain Age:</strong> ${result.details.domainAge}<br>` : ''}
                    <strong>Grammar Score:</strong> ${result.details?.grammarScore ?? '-'} / 100<br>
                    <strong>Analysis Time:</strong> ${new Date(result.timestamp).toLocaleString('en-LK', { timeZone: 'Asia/Colombo' })}
                </div>

                <div class="feedback-row" style="margin-top:10px; display:flex; gap:8px;">
                    <button class="btn btn-secondary btn-correct">üëç Correct</button>
                    <button class="btn btn-secondary btn-wrong">üëé Wrong</button>
                </div>
            `;

            // Attach event handlers that POST feedback
            const btnCorrect = div.querySelector('.btn-correct');
            const btnWrong = div.querySelector('.btn-wrong');

            // Build minimal payload
            const payloadBase = {
                analysis_id: result.analysis_id || null,            // returned by backend
                url: result.url || null,
                text_snippet: result.text ? String(result.text).slice(0, 200) : null,
                predicted_is_scam: !!result.isScam,
                user_note: null
            };

            btnCorrect.addEventListener('click', async () => {
                await sendFeedback({ ...payloadBase, is_correct: true });
                btnCorrect.disabled = btnWrong.disabled = true;
                showAlert('Thanks! Your feedback was recorded.', 'success');
            });

            btnWrong.addEventListener('click', async () => {
                await sendFeedback({ ...payloadBase, is_correct: false });
                btnCorrect.disabled = btnWrong.disabled = true;
                showAlert('Thanks! Your feedback was recorded.', 'success');
            });

            return div;
        }


        // async function sendFeedback(url, isScam, userFeedback) {
        //     try {
        //         const response = await fetch('/api/feedback', {
        //             method: 'POST',
        //             headers: { 'Content-Type': 'application/json' },
        //             body: JSON.stringify({
        //                 url: url,
        //                 is_scam: isScam,
        //                 user_feedback: userFeedback
        //             })
        //         });

        //         const data = await response.json();
        //         if (data.success) {
        //             alert('‚úÖ Thank you for your feedback!');
        //         } else {
        //             alert('‚ö†Ô∏è Failed to record feedback');
        //         }
        //     } catch (err) {
        //         console.error(err);
        //         alert('‚ö†Ô∏è Error sending feedback');
        //     }
        // }
        async function sendFeedback(payload) {
            try {
                const res = await fetch('/api/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (!res.ok || !data.success) {
                    throw new Error(data.error || 'Failed to save feedback');
                }
                return data;
            } catch (err) {
                console.error('Feedback error:', err);
                showAlert('Could not save feedback. Please try again.', 'error');
            }
        }



        function updateStats(result) {
            analysisStats.totalChecked++;
            if (result.isScam) {
                analysisStats.scamsDetected++;
            } else {
                analysisStats.safeScholarships++;
            }
            
            updateStatsDisplay();
            saveStats();
        }

        function updateStatsDisplay() {
            document.getElementById('totalChecked').textContent = analysisStats.totalChecked;
            document.getElementById('scamsDetected').textContent = analysisStats.scamsDetected;
            document.getElementById('safeScholarships').textContent = analysisStats.safeScholarships;
        }

        function saveStats() {
            // In a real implementation, you'd save to backend
            // For demo, we'll use memory only
        }

        function loadStoredStats() {
            // In a real implementation, you'd load from backend
            updateStatsDisplay();
        }

        function showAlert(message, type) {
            const alertId = type === 'success' ? 'successAlert' : 'errorAlert';
            const alert = document.getElementById(alertId);
            alert.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        function setLoadingState(button, isLoading) {
            if (isLoading) {
                button.disabled = true;
                button.textContent = 'Analyzing...';
            } else {
                button.disabled = false;
                button.textContent = button.id.includes('batch') ? 'Analyze All URLs' : 
                                   button.id.includes('text') ? 'Analyze Text' : 'Analyze Scholarship';
            }
        }

        function showLoading(show) {
            const loading = document.getElementById('loadingIndicator');
            loading.style.display = show ? 'block' : 'none';
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }


        async function loadAnalyticsCharts() {
            const res = await fetch('/api/statistics/extended');
            const data = await res.json();

            document.getElementById('accuracyRate').textContent = `${data.accuracy_rate}%`;

            // Scam vs Safe Chart
            new Chart(document.getElementById('scamChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Scams Detected', 'Safe Scholarships'],
                    datasets: [{
                        label: 'Analysis Count',
                        data: [data.scams_detected, data.safe_scholarships],
                        backgroundColor: ['#dc3545', '#28a745']
                    }]
                }
            });

            // Accuracy trend (last 10)
            const labels = data.trend_data.map(item => new Date(item.timestamp).toLocaleTimeString('en-LK', { timeZone: 'Asia/Colombo' }));
            const points = data.trend_data.map(item => item.scam ? 1 : 0);

            new Chart(document.getElementById('accuracyChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Scam (1) or Safe (0)',
                        data: points,
                        fill: false,
                        borderColor: '#007bff',
                        tension: 0.3
                    }]
                }
            });

            // Domain distribution pie chart
            const domains = Object.keys(data.domain_distribution);
            const domainCounts = Object.values(data.domain_distribution);

            new Chart(document.getElementById('domainChart'), {
                type: 'pie',
                data: {
                    labels: domains,
                    datasets: [{
                        data: domainCounts,
                        backgroundColor: generateColors(domainCounts.length)
                    }]
                }
            });
        }

        function generateColors(n) {
            const colors = ['#007bff', '#dc3545', '#ffc107', '#28a745', '#6610f2', '#20c997'];
            return Array.from({ length: n }, (_, i) => colors[i % colors.length]);
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadAnalyticsCharts();
        });

        async function loadHistory() {
            const res = await fetch('/api/history');
            const data = await res.json();
            

            const container = document.getElementById('historyResults');
            container.innerHTML = data.results.map(r => `
                <div class="history-item">
                    <strong>${r.url || 'Text Entry'}</strong><br>
                    Scam: ${r.is_scam ? 'Yes' : 'No'}<br>
                    Probability: ${Math.round(r.scam_probability * 100)}%<br>
                    Time: ${new Date(r.timestamp).toLocaleString('en-LK', { timeZone: 'Asia/Colombo' })}
                </div>
            `).join('');
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadHistory();
        });


    </script>
</body>
</html> -->

<!-- //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// -->
<!-- <!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fake Scholarship Detection System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    :root {
        --bg-primary: #f0f4f8;
        --bg-secondary: #ffffff;
        --bg-gradient-start: #667eea;
        --bg-gradient-end: #764ba2;
        --text-primary: #1a202c;
        --text-secondary: #4a5568;
        --text-muted: #718096;
        --border-color: #e2e8f0;
        --accent-color: #667eea;
        --accent-hover: #5568d3;
        --success-bg: #d4edda;
        --success-text: #155724;
        --warning-bg: #fff3cd;
        --warning-text: #856404;
        --danger-bg: #f8d7da;
        --danger-text: #721c24;
        --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        --card-hover-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
    }

    [data-theme="dark"] {
        --bg-primary: #0f172a;
        --bg-secondary: #1e293b;
        --bg-gradient-start: #4c1d95;
        --bg-gradient-end: #312e81;
        --text-primary: #f1f5f9;
        --text-secondary: #cbd5e1;
        --text-muted: #94a3b8;
        --border-color: #334155;
        --accent-color: #818cf8;
        --accent-hover: #6366f1;
        --success-bg: #064e3b;
        --success-text: #6ee7b7;
        --warning-bg: #78350f;
        --warning-text: #fcd34d;
        --danger-bg: #7f1d1d;
        --danger-text: #fca5a5;
        --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        --card-hover-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--bg-primary);
        min-height: 100vh;
        color: var(--text-primary);
        transition: background 0.3s ease, color 0.3s ease;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: clamp(1rem, 3vw, 2rem);
    }

    .header {
        text-align: center;
        padding: clamp(2rem, 5vw, 4rem) 0;
        background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
        border-radius: 30px;
        margin-bottom: clamp(2rem, 4vw, 3rem);
        position: relative;
        overflow: hidden;
        box-shadow: var(--card-shadow);
    }

    .header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="30" fill="rgba(255,255,255,0.05)"/></svg>');
        opacity: 0.1;
    }

    .header-content {
        position: relative;
        z-index: 1;
    }

    .theme-toggle {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        border: none;
        padding: 12px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .theme-toggle:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: rotate(180deg);
    }

    .header h1 {
        font-size: clamp(2rem, 5vw, 3.5rem);
        margin-bottom: 0.5rem;
        color: white;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        font-weight: 800;
        letter-spacing: -0.02em;
    }

    .header p {
        font-size: clamp(1rem, 2vw, 1.3rem);
        color: rgba(255, 255, 255, 0.95);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(min(250px, 100%), 1fr));
        gap: clamp(1rem, 2vw, 1.5rem);
        margin-bottom: clamp(2rem, 4vw, 3rem);
    }

    .stat-card {
        background: var(--bg-secondary);
        border-radius: 20px;
        padding: clamp(1.5rem, 3vw, 2rem);
        text-align: center;
        box-shadow: var(--card-shadow);
        transition: all 0.3s ease;
        border: 2px solid var(--border-color);
    }

    .stat-card:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: var(--card-hover-shadow);
        border-color: var(--accent-color);
    }

    .stat-number {
        font-size: clamp(2rem, 4vw, 3rem);
        font-weight: 800;
        background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .stat-label {
        color: var(--text-muted);
        margin-top: 0.5rem;
        font-size: clamp(0.875rem, 1.5vw, 1rem);
        font-weight: 500;
    }

    .main-content {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(min(400px, 100%), 1fr));
        gap: clamp(1.5rem, 3vw, 2rem);
        margin-bottom: clamp(2rem, 4vw, 3rem);
    }

    .card {
        background: var(--bg-secondary);
        border-radius: 24px;
        padding: clamp(1.5rem, 3vw, 2.5rem);
        box-shadow: var(--card-shadow);
        transition: all 0.3s ease;
        border: 2px solid var(--border-color);
    }

    .card:hover {
        transform: translateY(-3px);
        box-shadow: var(--card-hover-shadow);
    }

    .card h2 {
        color: var(--text-primary);
        margin-bottom: 1.5rem;
        font-size: clamp(1.25rem, 2.5vw, 1.75rem);
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .card h2::before {
        content: '';
        width: 4px;
        height: 24px;
        background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
        border-radius: 2px;
    }

    .input-group {
        margin-bottom: 1.5rem;
    }

    .input-group label {
        display: block;
        margin-bottom: 0.75rem;
        font-weight: 600;
        color: var(--text-secondary);
        font-size: clamp(0.875rem, 1.5vw, 1rem);
    }

    .input-group input,
    .input-group textarea {
        width: 100%;
        padding: clamp(0.75rem, 2vw, 1rem);
        border: 2px solid var(--border-color);
        border-radius: 12px;
        font-size: clamp(0.875rem, 1.5vw, 1rem);
        transition: all 0.3s ease;
        background: var(--bg-primary);
        color: var(--text-primary);
    }

    .input-group input:focus,
    .input-group textarea:focus {
        outline: none;
        border-color: var(--accent-color);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .input-group textarea {
        resize: vertical;
        min-height: 120px;
        font-family: inherit;
    }

    .btn {
        background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
        color: white;
        border: none;
        padding: clamp(0.875rem, 2vw, 1.125rem) clamp(1.5rem, 3vw, 2rem);
        border-radius: 12px;
        font-size: clamp(0.875rem, 1.5vw, 1rem);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        position: relative;
        overflow: hidden;
    }

    .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transition: left 0.5s ease;
    }

    .btn:hover::before {
        left: 100%;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .btn-secondary {
        background: var(--bg-primary);
        color: var(--text-primary);
        border: 2px solid var(--border-color);
        padding: 0.5rem 1rem;
        width: auto;
    }

    .btn-secondary:hover {
        background: var(--accent-color);
        color: white;
        border-color: var(--accent-color);
    }

    .tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid var(--border-color);
        flex-wrap: wrap;
    }

    .tab {
        padding: clamp(0.75rem, 2vw, 1rem) clamp(1rem, 2.5vw, 1.5rem);
        cursor: pointer;
        border: none;
        background: none;
        font-size: clamp(0.875rem, 1.5vw, 1rem);
        color: var(--text-muted);
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
        font-weight: 500;
    }

    .tab.active {
        color: var(--accent-color);
        border-bottom-color: var(--accent-color);
        font-weight: 700;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .results-section {
        background: var(--bg-secondary);
        border-radius: 24px;
        padding: clamp(1.5rem, 3vw, 2.5rem);
        box-shadow: var(--card-shadow);
        margin-bottom: 2rem;
        border: 2px solid var(--border-color);
    }

    .results-section h2 {
        color: var(--text-primary);
        margin-bottom: 1.5rem;
        font-size: clamp(1.5rem, 3vw, 2rem);
        font-weight: 700;
    }

    .result-item {
        background: var(--bg-primary);
        border-radius: 16px;
        padding: clamp(1rem, 2.5vw, 1.5rem);
        margin-bottom: 1rem;
        border-left: 4px solid var(--accent-color);
        transition: all 0.3s ease;
    }

    .result-item:hover {
        transform: translateX(5px);
        box-shadow: var(--card-shadow);
    }

    .result-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .result-url {
        font-weight: 600;
        color: var(--text-primary);
        word-break: break-all;
        font-size: clamp(0.875rem, 1.5vw, 1rem);
        flex: 1;
        min-width: 200px;
    }

    .probability-badge {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 700;
        font-size: clamp(0.75rem, 1.5vw, 0.875rem);
        white-space: nowrap;
    }

    .safe {
        background: var(--success-bg);
        color: var(--success-text);
    }

    .warning {
        background: var(--warning-bg);
        color: var(--warning-text);
    }

    .danger {
        background: var(--danger-bg);
        color: var(--danger-text);
    }

    .progress-bar {
        width: 100%;
        height: 10px;
        background: var(--border-color);
        border-radius: 10px;
        overflow: hidden;
        margin: 1rem 0;
    }

    .progress-fill {
        height: 100%;
        transition: width 0.5s ease;
        border-radius: 10px;
    }

    .result-details {
        margin-top: 1rem;
        font-size: clamp(0.875rem, 1.5vw, 1rem);
        color: var(--text-secondary);
        line-height: 1.8;
    }

    .feedback-row {
        margin-top: 1rem;
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .loading {
        display: none;
        text-align: center;
        padding: 2rem;
    }

    .spinner {
        border: 4px solid var(--border-color);
        border-top: 4px solid var(--accent-color);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .alert {
        padding: 1rem 1.5rem;
        border-radius: 12px;
        margin-bottom: 1.5rem;
        display: none;
        font-size: clamp(0.875rem, 1.5vw, 1rem);
        animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .alert-success {
        background: var(--success-bg);
        color: var(--success-text);
    }

    .alert-error {
        background: var(--danger-bg);
        color: var(--danger-text);
    }

    .feature-list {
        list-style: none;
        padding: 0;
    }

    .feature-list li {
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: clamp(0.875rem, 1.5vw, 1rem);
    }

    .feature-list li:last-child {
        border-bottom: none;
    }

    .feature-list li::before {
        content: "‚úì";
        color: #28a745;
        font-weight: bold;
        font-size: 1.25rem;
        flex-shrink: 0;
    }

    canvas {
        max-width: 100%;
        height: auto !important;
        margin: 1rem auto;
        display: block;
    }

    .history-item {
        background: var(--bg-primary);
        padding: 1rem;
        border-radius: 12px;
        margin-bottom: 0.75rem;
        border-left: 3px solid var(--accent-color);
        font-size: clamp(0.875rem, 1.5vw, 1rem);
    }

    @media (max-width: 768px) {
        .main-content {
            grid-template-columns: 1fr;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .theme-toggle {
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            font-size: 20px;
        }
    }

    @media (max-width: 480px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        
        .result-header {
            flex-direction: column;
        }
        
        .feedback-row {
            flex-direction: column;
        }
        
        .btn-secondary {
            width: 100%;
        }
    }
    </style>
    </head>
        <body>
            <div class="container">
            <header class="header">
            <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">üåô</button>
            <div class="header-content">
            <h1>üõ°Ô∏è Scholarship Shield</h1>
            <p>Protect yourself from fake scholarship scams using AI-powered detection</p>
            </div>
            </header>

            <div class="stats-grid">
            <div class="stat-card">
            <div class="stat-number" id="totalChecked">0</div>
            <div class="stat-label">URLs Analyzed</div>
            </div>
            <div class="stat-card">
            <div class="stat-number" id="scamsDetected">0</div>
            <div class="stat-label">Scams Detected</div>
            </div>
            <div class="stat-card">
            <div class="stat-number" id="safeScholarships">0</div>
            <div class="stat-label">Safe Scholarships</div>
            </div>
            <div class="stat-card">
            <div class="stat-number" id="accuracyRate">0%</div>
            <div class="stat-label">Accuracy Rate</div>
            </div>
            </div>

            <div class="alert alert-success" id="successAlert"></div>
            <div class="alert alert-error" id="errorAlert"></div>

            <div class="main-content">
            <div class="card">
            <h2>Single URL Analysis</h2>
            <form id="singleUrlForm">
            <div class="input-group">
            <label for="scholarshipUrl">Scholarship URL</label>
            <input type="url" id="scholarshipUrl" placeholder="https://example.com/scholarship" required>
            </div>
            <button type="submit" class="btn" id="analyzeBtn">Analyze Scholarship</button>
            </form>
            </div>

            <div class="card">
            <h2>Text Analysis</h2>
            <form id="textAnalysisForm">
            <div class="input-group">
            <label for="scholarshipText">Scholarship Description</label>
            <textarea id="scholarshipText" placeholder="Paste the scholarship description here..." required></textarea>
            </div>
            <button type="submit" class="btn" id="analyzeTextBtn">Analyze Text</button>
            </form>
            </div>
            </div>

            <div class="card">
            <h2>Batch Analysis</h2>
            <div class="tabs">
            <button class="tab active" onclick="switchTab('urls')">Multiple URLs</button>
            <button class="tab" onclick="switchTab('upload')">Upload File</button>
            </div>

            <div class="tab-content active" id="urls-content">
            <form id="batchUrlForm">
            <div class="input-group">
            <label for="batchUrls">Multiple URLs (one per line)</label>
            <textarea id="batchUrls" placeholder="https://example1.com/scholarship&#10;https://example2.com/scholarship&#10;https://example3.com/scholarship" rows="6"></textarea>
            </div>
            <button type="submit" class="btn" id="batchAnalyzeBtn">Analyze All URLs</button>
            </form>
            </div>

            <div class="tab-content" id="upload-content">
            <div class="input-group">
            <label for="fileUpload">Upload CSV/TXT file with URLs</label>
            <input type="file" id="fileUpload" accept=".csv,.txt">
            </div>
            <button type="button" class="btn" id="uploadAnalyzeBtn" onclick="handleFileUpload()">Analyze Uploaded File</button>
            </div>
            </div>

            <div class="card">
            <h2>Analysis History</h2>
            <div id="historyResults"></div>
            </div>

            <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p>Analyzing scholarship data...</p>
            </div>

            <div class="results-section" id="resultsSection" style="display: none;">
            <h2>üìä Analysis Results</h2>
            <div id="resultsContainer"></div>
            </div>

            <div class="card">
            <h2>üìà Analytics Dashboard</h2>
            <canvas id="scamChart">Scam Chart</canvas>
            <canvas id="accuracyChart">Accuracy Chart</canvas>
            <canvas id="domainChart">Domain Chart</canvas>
            </div>

            <div class="card">
            <h2>‚öôÔ∏è How It Works</h2>
            <ul class="feature-list">
            <li>Advanced NLP analysis of scholarship descriptions</li>
            <li>Domain reputation and age verification</li>
            <li>Suspicious keyword and phrase detection</li>
            <li>Grammar and language pattern analysis</li>
            <li>Machine learning classification (BERT model)</li>
            <li>Real-time scam probability scoring</li>
            <li>Batch processing for multiple URLs</li>
            <li>Detailed risk assessment reports</li>
            </ul>
            </div>
            </div>

            <script>
            // Theme toggle
            function toggleTheme() {
                const html = document.documentElement;
                const currentTheme = html.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                html.setAttribute('data-theme', newTheme);
                
                const toggle = document.getElementById('themeToggle');
                toggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                
                // Store preference
                try {
                    localStorage.setItem('theme', newTheme);
                } catch (e) {
                    console.log('Could not save theme preference');
                }
            }

            // Load saved theme
            document.addEventListener('DOMContentLoaded', function() {
                try {
                    const savedTheme = localStorage.getItem('theme') || 'light';
                    document.documentElement.setAttribute('data-theme', savedTheme);
                    document.getElementById('themeToggle').textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                } catch (e) {
                    console.log('Could not load theme preference');
                }
                
                initializeEventListeners();
                loadStoredStats();
            });

            // Global variables
            let analysisStats = {
                totalChecked: 0,
                scamsDetected: 0,
                safeScholarships: 0
            };

            function initializeEventListeners() {
                document.getElementById('singleUrlForm').addEventListener('submit', handleSingleUrlAnalysis);
                document.getElementById('textAnalysisForm').addEventListener('submit', handleTextAnalysis);
                document.getElementById('batchUrlForm').addEventListener('submit', handleBatchAnalysis);
                document.getElementById('uploadAnalyzeBtn').addEventListener('click', handleFileUpload);
            }

            function switchTab(tabName) {
                document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                event.target.classList.add('active');
                document.getElementById(tabName + '-content').classList.add('active');
            }

            async function handleSingleUrlAnalysis(event) {
                event.preventDefault();
                const url = document.getElementById('scholarshipUrl').value;
                const button = document.getElementById('analyzeBtn');

                if (!url) {
                    showAlert('Please enter a valid URL', 'error');
                    return;
                }

                setLoadingState(button, true);
                showLoading(true);

                try {
                    const result = await analyzeScholarship(url);
                    displayResults([result]);
                    updateStats(result);
                    showAlert('Analysis completed successfully!', 'success');
                } catch (error) {
                    showAlert('Error analyzing scholarship: ' + error.message, 'error');
                } finally {
                    setLoadingState(button, false);
                    showLoading(false);
                }
            }

            async function handleTextAnalysis(event) {
                event.preventDefault();
                const text = document.getElementById('scholarshipText').value;
                const button = document.getElementById('analyzeTextBtn');

                if (!text.trim()) {
                    showAlert('Please enter scholarship text to analyze', 'error');
                    return;
                }

                setLoadingState(button, true);
                showLoading(true);

                try {
                    const result = await analyzeText(text);
                    displayResults([result]);
                    updateStats(result);
                    showAlert('Text analysis completed successfully!', 'success');
                } catch (error) {
                    showAlert('Error analyzing text: ' + error.message, 'error');
                } finally {
                    setLoadingState(button, false);
                    showLoading(false);
                }
            }

            async function handleBatchAnalysis(event) {
                event.preventDefault();
                const urlsText = document.getElementById('batchUrls').value;
                const button = document.getElementById('batchAnalyzeBtn');

                if (!urlsText.trim()) {
                    showAlert('Please enter URLs to analyze', 'error');
                    return;
                }

                const urls = urlsText.split('\n').filter(url => url.trim());

                if (urls.length === 0) {
                    showAlert('No valid URLs found', 'error');
                    return;
                }

                setLoadingState(button, true);
                showLoading(true);

                try {
                    const results = await Promise.all(urls.map(url => analyzeScholarship(url.trim())));
                    displayResults(results);
                    results.forEach(result => updateStats(result));
                    showAlert(`Batch analysis completed! Analyzed ${results.length} URLs.`, 'success');
                } catch (error) {
                    showAlert('Error in batch analysis: ' + error.message, 'error');
                } finally {
                    setLoadingState(button, false);
                    showLoading(false);
                }
            }

            async function handleFileUpload() {
                const fileInput = document.getElementById('fileUpload');
                const file = fileInput.files[0];

                if (!file) {
                    showAlert('Please select a file to upload', 'error');
                    return;
                }

                const allowedTypes = ['text/plain', 'text/csv'];
                if (!allowedTypes.includes(file.type)) {
                    showAlert('Only TXT, CSV files are supported.', 'error');
                    return;
                }

                const button = document.getElementById('uploadAnalyzeBtn');
                setLoadingState(button, true);
                showLoading(true);

                try {
                    const text = await readFile(file);
                    const urls = text.split('\n').filter(url => url.trim());

                    if (urls.length === 0) {
                        showAlert('No valid URLs found in file', 'error');
                        return;
                    }

                    const results = await Promise.all(urls.map(url => analyzeScholarship(url.trim())));
                    displayResults(results);
                    results.forEach(result => updateStats(result));
                    showAlert(`File analysis completed! Analyzed ${results.length} URLs.`, 'success');
                } catch (error) {
                    showAlert('Error processing file: ' + error.message, 'error');
                } finally {
                    setLoadingState(button, false);
                    showLoading(false);
                }
            }

            async function analyzeScholarship(url) {
                const response = await fetch('/api/analyze-url', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to analyze URL');
                }

                const data = await response.json();
                return {
                    url: data.url,
                    scamProbability: data.scam_probability,
                    isScam: data.is_scam,
                    riskLevel: data.risk_level,
                    details: {
                        suspiciousKeywords: data.details.suspicious_keywords,
                        domainAge: data.details.domain_age,
                        grammarScore: data.details.grammar_score,
                        legitimacyIndicators: data.details.legitimacy_indicators
                    },
                    timestamp: data.timestamp
                };
            }

            async function analyzeText(text) {
                const response = await fetch('/api/analyze-text', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to analyze text');
                }

                const data = await response.json();
                return {
                    url: data.url,
                    text: data.text,
                    scamProbability: data.scam_probability,
                    isScam: data.is_scam,
                    riskLevel: data.risk_level,
                    details: {
                        suspiciousKeywords: data.details.suspicious_keywords,
                        sentimentScore: data.details.sentiment_score,
                        grammarScore: data.details.grammar_score,
                        readabilityScore: data.details.readability_score
                    },
                    timestamp: data.timestamp
                };
            }

            function displayResults(results) {
                const container = document.getElementById('resultsContainer');
                const section = document.getElementById('resultsSection');
                container.innerHTML = '';

                results.forEach(result => {
                    const resultElement = createResultElement(result);
                    container.appendChild(resultElement);
                });

                section.style.display = 'block';
                section.scrollIntoView({ behavior: 'smooth' });
            }

            function createResultElement(result) {
                const div = document.createElement('div');
                div.className = 'result-item';

                const riskClass = result.riskLevel === 'high' ? 'danger' :
                                result.riskLevel === 'medium' ? 'warning' : 'safe';
                const percentage = Math.round(result.scamProbability * 100);
                const localTime = new Date(result.timestamp).toLocaleString('en-LK', { timeZone: 'Asia/Colombo' });

                div.innerHTML = `
                    <div class="result-header">
                        <div class="result-url">${result.url || 'Text Analysis'}</div>
                        <div class="probability-badge ${riskClass}">
                            ${percentage}% Risk
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${percentage}%; background: ${
                            result.riskLevel === 'high' ? '#dc3545' :
                            result.riskLevel === 'medium' ? '#ffc107' : '#28a745'
                        }"></div>
                    </div>
                    <div class="result-details">
                        <strong>Risk Level:</strong> ${result.riskLevel?.toUpperCase() || '-'}<br>
                        <strong>Suspicious Keywords:</strong> ${(result.details?.suspiciousKeywords || []).join(', ') || 'None detected'}<br>
                        ${result.details?.domainAge ? `<strong>Domain Age:</strong> ${result.details.domainAge}<br>` : ''}
                        <strong>Grammar Score:</strong> ${result.details?.grammarScore ?? '-'} / 100<br>
                        <strong>Analysis Time:</strong> ${localTime}
                    </div>
                    <div class="feedback-row">
                        <button class="btn btn-secondary btn-correct">‚úì Correct</button>
                        <button class="btn btn-secondary btn-wrong">‚úó Wrong</button>
                    </div>
                `;

                const btnCorrect = div.querySelector('.btn-correct');
                const btnWrong = div.querySelector('.btn-wrong');

                const payloadBase = {
                    analysis_id: result.analysis_id || null,
                    url: result.url || null,
                    text_snippet: result.text ? String(result.text).slice(0, 200) : null,
                    predicted_is_scam: !!result.isScam,
                    user_note: null
                };

                btnCorrect.addEventListener('click', async () => {
                    await sendFeedback({ ...payloadBase, is_correct: true });
                    btnCorrect.disabled = btnWrong.disabled = true;
                    showAlert('Thanks! Your feedback was recorded.', 'success');
                });

                btnWrong.addEventListener('click', async () => {
                    await sendFeedback({ ...payloadBase, is_correct: false });
                    btnCorrect.disabled = btnWrong.disabled = true;
                    showAlert('Thanks! Your feedback was recorded.', 'success');
                });

                return div;
            }

            async function sendFeedback(payload) {
                try {
                    const res = await fetch('/api/feedback', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    if (!res.ok || !data.success) {
                        throw new Error(data.error || 'Failed to save feedback');
                    }
                    return data;
                } catch (err) {
                    console.error('Feedback error:', err);
                    showAlert('Could not save feedback. Please try again.', 'error');
                }
            }

            function updateStats(result) {
                analysisStats.totalChecked++;
                if (result.isScam) {
                    analysisStats.scamsDetected++;
                } else {
                    analysisStats.safeScholarships++;
                }
                updateStatsDisplay();
            }

            function updateStatsDisplay() {
                document.getElementById('totalChecked').textContent = analysisStats.totalChecked;
                document.getElementById('scamsDetected').textContent = analysisStats.scamsDetected;
                document.getElementById('safeScholarships').textContent = analysisStats.safeScholarships;
            }

            function loadStoredStats() {
                updateStatsDisplay();
            }

            function showAlert(message, type) {
                const alertId = type === 'success' ? 'successAlert' : 'errorAlert';
                const alert = document.getElementById(alertId);
                alert.textContent = message;
                alert.style.display = 'block';

                setTimeout(() => {
                    alert.style.display = 'none';
                }, 5000);
            }

            function setLoadingState(button, isLoading) {
                if (isLoading) {
                    button.disabled = true;
                    button.textContent = 'Analyzing...';
                } else {
                    button.disabled = false;
                    button.textContent = button.id.includes('batch') ? 'Analyze All URLs' :
                                        button.id.includes('text') ? 'Analyze Text' : 
                                        button.id.includes('upload') ? 'Analyze Uploaded File' : 'Analyze Scholarship';
                }
            }

            function showLoading(show) {
                const loading = document.getElementById('loadingIndicator');
                loading.style.display = show ? 'block' : 'none';
            }

            function readFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = e => reject(new Error('Failed to read file'));
                    reader.readAsText(file);
                });
            }

            async function loadAnalyticsCharts() {
                try {
                    const res = await fetch('/api/statistics/extended');
                    const data = await res.json();
                    
                    document.getElementById('accuracyRate').textContent = `${data.accuracy_rate}%`;

                    // Scam vs Safe Chart
                    new Chart(document.getElementById('scamChart'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Scams Detected', 'Safe Scholarships'],
                            datasets: [{
                                label: 'Analysis Count',
                                data: [data.scams_detected, data.safe_scholarships],
                                backgroundColor: ['#dc3545', '#28a745']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });

                    // Accuracy trend
                    const labels = data.trend_data.map(item => 
                        new Date(item.timestamp).toLocaleTimeString('en-LK', { timeZone: 'Asia/Colombo' })
                    );
                    const points = data.trend_data.map(item => item.scam ? 1 : 0);

                    new Chart(document.getElementById('accuracyChart'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Scam (1) or Safe (0)',
                                data: points,
                                fill: false,
                                borderColor: '#007bff',
                                tension: 0.3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });

                    // Domain distribution
                    const domains = Object.keys(data.domain_distribution);
                    const domainCounts = Object.values(data.domain_distribution);

                    new Chart(document.getElementById('domainChart'), {
                        type: 'pie',
                        data: {
                            labels: domains,
                            datasets: [{
                                data: domainCounts,
                                backgroundColor: generateColors(domainCounts.length)
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error loading analytics:', error);
                }
            }

            function generateColors(n) {
                const colors = ['#007bff', '#dc3545', '#ffc107', '#28a745', '#6610f2', '#20c997'];
                return Array.from({ length: n }, (_, i) => colors[i % colors.length]);
            }

            async function loadHistory() {
                try {
                    const res = await fetch('/api/history');
                    const data = await res.json();
                    const container = document.getElementById('historyResults');
                    
                    if (data.results && data.results.length > 0) {
                        container.innerHTML = data.results.map(r => `
                            <div class="history-item">
                                <strong>${r.url || 'Text Entry'}</strong><br>
                                Scam: ${r.is_scam ? 'Yes' : 'No'}<br>
                                Probability: ${Math.round(r.scam_probability * 100)}%<br>
                                Time: ${new Date(r.timestamp).toLocaleString('en-LK', { timeZone: 'Asia/Colombo' })}
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No analysis history yet</p>';
                    }
                } catch (error) {
                    console.error('Error loading history:', error);
                }
            }

            // Initialize everything on page load
            document.addEventListener('DOMContentLoaded', () => {
                loadAnalyticsCharts();
                loadHistory();
            });
            </script>
    </body>
</html> -->

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fake Scholarship Detection System</title>
<link rel="stylesheet" type="text/css" href="{{url_for('static',filename='styles.css')}}" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>
<div class="container">
<header class="header">
<button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">üåô</button>
<div class="header-content">
<h1>üõ°Ô∏è Scholarship Shield</h1>
<p>Protect yourself from fake scholarship scams using AI-powered detection</p>
</div>
</header>

<div class="stats-grid">
<div class="stat-card">
<div class="stat-number" id="totalChecked">0</div>
<div class="stat-label">URLs Analyzed</div>
</div>
<div class="stat-card">
<div class="stat-number" id="scamsDetected">0</div>
<div class="stat-label">Scams Detected</div>
</div>
<div class="stat-card">
<div class="stat-number" id="safeScholarships">0</div>
<div class="stat-label">Safe Scholarships</div>
</div>
<div class="stat-card">
<div class="stat-number" id="accuracyRate">0%</div>
<div class="stat-label">Accuracy Rate</div>
</div>
</div>

<div class="alert alert-success" id="successAlert"></div>
<div class="alert alert-error" id="errorAlert"></div>

<div class="main-content">
<div class="card">
<h2>Single URL Analysis</h2>
<form id="singleUrlForm">
<div class="input-group">
<label for="scholarshipUrl">Scholarship URL</label>
<input type="url" id="scholarshipUrl" placeholder="https://example.com/scholarship" required>
</div>
<button type="submit" class="btn" id="analyzeBtn">Analyze Scholarship</button>
</form>
</div>

<div class="card">
<h2>Text Analysis</h2>
<form id="textAnalysisForm">
<div class="input-group">
<label for="scholarshipText">Scholarship Description</label>
<textarea id="scholarshipText" placeholder="Paste the scholarship description here..." required></textarea>
</div>
<button type="submit" class="btn" id="analyzeTextBtn">Analyze Text</button>
</form>
</div>
</div>

<div class="card">
<h2>Batch Analysis</h2>
<div class="tabs">
<button class="tab active" onclick="switchTab('urls')">Multiple URLs</button>
<button class="tab" onclick="switchTab('upload')">Upload File</button>
</div>

<div class="tab-content active" id="urls-content">
<form id="batchUrlForm">
<div class="input-group">
<label for="batchUrls">Multiple URLs (one per line)</label>
<textarea id="batchUrls" placeholder="https://example1.com/scholarship&#10;https://example2.com/scholarship&#10;https://example3.com/scholarship" rows="6"></textarea>
</div>
<button type="submit" class="btn" id="batchAnalyzeBtn">Analyze All URLs</button>
</form>
</div>

<div class="tab-content" id="upload-content">
<div class="input-group">
<label for="fileUpload">Upload CSV/TXT file with URLs</label>
<input type="file" id="fileUpload" accept=".csv,.txt">
</div>
<button type="button" class="btn" id="uploadAnalyzeBtn" onclick="handleFileUpload()">Analyze Uploaded File</button>
</div>
</div>

<div class="card">
<h2>Analysis History</h2>
<div id="historyResults"></div>
</div>

<div class="loading" id="loadingIndicator">
<div class="spinner"></div>
<p>Analyzing scholarship data...</p>
</div>

<div class="results-section" id="resultsSection" style="display: none;">
<h2>üìä Analysis Results</h2>
<div id="resultsContainer"></div>
</div>

<div class="analytics-dashboard">
<h2 class="dashboard-title">üìà Analytics Dashboard</h2>
<div class="charts-grid">
<div class="chart-card">
<div class="chart-header">
<div class="chart-icon">üéØ</div>
<div class="chart-info">
<h3>Detection Overview</h3>
<p>Scams vs Safe Scholarships</p>
</div>
</div>
<div class="chart-container">
<canvas id="scamChart"></canvas>
</div>
<div class="chart-footer">
<div class="chart-stat">
<span class="stat-value" id="scamPercentage">0%</span>
<span class="stat-label">Scam Rate</span>
</div>
<div class="chart-stat">
<span class="stat-value" id="safePercentage">0%</span>
<span class="stat-label">Safe Rate</span>
</div>
</div>
</div>

<div class="chart-card">
<div class="chart-header">
<div class="chart-icon">üìä</div>
<div class="chart-info">
<h3>Analysis Trend</h3>
<p>Recent Detection Pattern</p>
</div>
</div>
<div class="chart-container">
<canvas id="accuracyChart"></canvas>
</div>
<div class="chart-footer">
<div class="chart-stat">
<span class="stat-value" id="trendDirection">‚Üí</span>
<span class="stat-label">Trend</span>
</div>
<div class="chart-stat">
<span class="stat-value" id="avgRisk">0%</span>
<span class="stat-label">Avg Risk</span>
</div>
</div>
</div>

<div class="chart-card">
<div class="chart-header">
<div class="chart-icon">üåê</div>
<div class="chart-info">
<h3>Domain Distribution</h3>
<p>Top Analyzed Domains</p>
</div>
</div>
<div class="chart-container">
<canvas id="domainChart"></canvas>
</div>
<div class="chart-footer">
<div class="chart-stat">
<span class="stat-value" id="uniqueDomains">0</span>
<span class="stat-label">Unique Domains</span>
</div>
<div class="chart-stat">
<span class="stat-value" id="topDomain">-</span>
<span class="stat-label">Most Analyzed</span>
</div>
</div>
</div>
</div>
</div>

<div class="card">
<h2>‚öôÔ∏è How It Works</h2>
<ul class="feature-list">
<li>Advanced NLP analysis of scholarship descriptions</li>
<li>Domain reputation and age verification</li>
<li>Suspicious keyword and phrase detection</li>
<li>Grammar and language pattern analysis</li>
<li>Machine learning classification (BERT model)</li>
<li>Real-time scam probability scoring</li>
<li>Batch processing for multiple URLs</li>
<li>Detailed risk assessment reports</li>
</ul>
</div>
</div>

<footer class="app-footer">
<div class="footer-content">
<div class="footer-section footer-brand">
<div class="footer-logo">
<div class="footer-icon">üõ°Ô∏è</div>
<div class="footer-title">
<h3>Scholarship Shield</h3>
<p>AI-Powered Protection</p>
</div>
</div>
<p class="footer-description">
Protecting students from scholarship scams using advanced artificial intelligence and machine learning technology.
</p>
<div class="footer-social">
<a href="#" class="social-link" title="Facebook">
<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
<path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
</svg>
</a>
<a href="#" class="social-link" title="Twitter">
<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
<path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
</svg>
</a>
<a href="#" class="social-link" title="LinkedIn">
<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
<path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
</svg>
</a>
<a href="#" class="social-link" title="GitHub">
<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
<path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/>
</svg>
</a>
</div>
</div>

<div class="footer-section footer-links">
<h4>Quick Links</h4>
<ul>
<li><a href="#stats">Dashboard</a></li>
<li><a href="#analysis">Start Analysis</a></li>
<li><a href="#history">View History</a></li>
<li><a href="#analytics">Analytics</a></li>
<li><a href="#how-it-works">How It Works</a></li>
</ul>
</div>

<div class="footer-section footer-resources">
<h4>Resources</h4>
<ul>
<li><a href="#">Documentation</a></li>
<li><a href="#">API Reference</a></li>
<li><a href="#">Safety Tips</a></li>
<li><a href="#">Report Scam</a></li>
<li><a href="#">Community Forum</a></li>
</ul>
</div>

<div class="footer-section footer-contact">
<h4>Contact Us</h4>
<ul class="contact-info">
<li>
<span class="contact-icon">üìß</span>
<a href="mailto:support@scholarshipshield.com">support@scholarshipshield.com</a>
</li>
<li>
<span class="contact-icon">üì±</span>
<span>+94 77 123 4567</span>
</li>
<li>
<span class="contact-icon">üìç</span>
<span>Negombo, Sri Lanka</span>
</li>
</ul>
<div class="footer-newsletter">
<p>Stay updated with security alerts</p>
<div class="newsletter-form">
<input type="email" placeholder="Your email" />
<button>Subscribe</button>
</div>
</div>
</div>
</div>

<div class="footer-bottom">
<div class="footer-bottom-content">
<p class="copyright">
¬© 2025 Scholarship Shield. All rights reserved. | Made with ‚ù§Ô∏è for student safety
</p>
<div class="footer-bottom-links">
<a href="#">Privacy Policy</a>
<span class="separator">‚Ä¢</span>
<a href="#">Terms of Service</a>
<span class="separator">‚Ä¢</span>
<a href="#">Cookie Policy</a>
</div>
</div>
</div>

<div class="footer-wave">
<svg viewBox="0 0 1200 120" preserveAspectRatio="none">
<path d="M321.39,56.44c58-10.79,114.16-30.13,172-41.86,82.39-16.72,168.19-17.73,250.45-.39C823.78,31,906.67,72,985.66,92.83c70.05,18.48,146.53,26.09,214.34,3V0H0V27.35A600.21,600.21,0,0,0,321.39,56.44Z" fill="currentColor"></path>
</svg>
</div>
</footer>
</div>

<script>
// Theme toggle
function toggleTheme() {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', newTheme);
    
    const toggle = document.getElementById('themeToggle');
    toggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    
    // Store preference
    try {
        localStorage.setItem('theme', newTheme);
    } catch (e) {
        console.log('Could not save theme preference');
    }
}

// Load saved theme
document.addEventListener('DOMContentLoaded', function() {
    try {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.getElementById('themeToggle').textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    } catch (e) {
        console.log('Could not load theme preference');
    }
    
    initializeEventListeners();
    loadStoredStats();
});

// Global variables
let analysisStats = {
    totalChecked: 0,
    scamsDetected: 0,
    safeScholarships: 0
};

function initializeEventListeners() {
    document.getElementById('singleUrlForm').addEventListener('submit', handleSingleUrlAnalysis);
    document.getElementById('textAnalysisForm').addEventListener('submit', handleTextAnalysis);
    document.getElementById('batchUrlForm').addEventListener('submit', handleBatchAnalysis);
    document.getElementById('uploadAnalyzeBtn').addEventListener('click', handleFileUpload);
}

function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tabName + '-content').classList.add('active');
}

async function handleSingleUrlAnalysis(event) {
    event.preventDefault();
    const url = document.getElementById('scholarshipUrl').value;
    const button = document.getElementById('analyzeBtn');

    if (!url) {
        showAlert('Please enter a valid URL', 'error');
        return;
    }

    setLoadingState(button, true);
    showLoading(true);

    try {
        const result = await analyzeScholarship(url);
        displayResults([result]);
        updateStats(result);
        showAlert('Analysis completed successfully!', 'success');
    } catch (error) {
        showAlert('Error analyzing scholarship: ' + error.message, 'error');
    } finally {
        setLoadingState(button, false);
        showLoading(false);
    }
}

async function handleTextAnalysis(event) {
    event.preventDefault();
    const text = document.getElementById('scholarshipText').value;
    const button = document.getElementById('analyzeTextBtn');

    if (!text.trim()) {
        showAlert('Please enter scholarship text to analyze', 'error');
        return;
    }

    setLoadingState(button, true);
    showLoading(true);

    try {
        const result = await analyzeText(text);
        displayResults([result]);
        updateStats(result);
        showAlert('Text analysis completed successfully!', 'success');
    } catch (error) {
        showAlert('Error analyzing text: ' + error.message, 'error');
    } finally {
        setLoadingState(button, false);
        showLoading(false);
    }
}

async function handleBatchAnalysis(event) {
    event.preventDefault();
    const urlsText = document.getElementById('batchUrls').value;
    const button = document.getElementById('batchAnalyzeBtn');

    if (!urlsText.trim()) {
        showAlert('Please enter URLs to analyze', 'error');
        return;
    }

    const urls = urlsText.split('\n').filter(url => url.trim());

    if (urls.length === 0) {
        showAlert('No valid URLs found', 'error');
        return;
    }

    setLoadingState(button, true);
    showLoading(true);

    try {
        const results = await Promise.all(urls.map(url => analyzeScholarship(url.trim())));
        displayResults(results);
        results.forEach(result => updateStats(result));
        showAlert(`Batch analysis completed! Analyzed ${results.length} URLs.`, 'success');
    } catch (error) {
        showAlert('Error in batch analysis: ' + error.message, 'error');
    } finally {
        setLoadingState(button, false);
        showLoading(false);
    }
}

async function handleFileUpload() {
    const fileInput = document.getElementById('fileUpload');
    const file = fileInput.files[0];

    if (!file) {
        showAlert('Please select a file to upload', 'error');
        return;
    }

    const allowedTypes = ['text/plain', 'text/csv'];
    if (!allowedTypes.includes(file.type)) {
        showAlert('Only TXT, CSV files are supported.', 'error');
        return;
    }

    const button = document.getElementById('uploadAnalyzeBtn');
    setLoadingState(button, true);
    showLoading(true);

    try {
        const text = await readFile(file);
        const urls = text.split('\n').filter(url => url.trim());

        if (urls.length === 0) {
            showAlert('No valid URLs found in file', 'error');
            return;
        }

        const results = await Promise.all(urls.map(url => analyzeScholarship(url.trim())));
        displayResults(results);
        results.forEach(result => updateStats(result));
        showAlert(`File analysis completed! Analyzed ${results.length} URLs.`, 'success');
    } catch (error) {
        showAlert('Error processing file: ' + error.message, 'error');
    } finally {
        setLoadingState(button, false);
        showLoading(false);
    }
}

async function analyzeScholarship(url) {
    const response = await fetch('/api/analyze-url', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url })
    });

    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to analyze URL');
    }

    const data = await response.json();
    return {
        url: data.url,
        scamProbability: data.scam_probability,
        isScam: data.is_scam,
        riskLevel: data.risk_level,
        details: {
            suspiciousKeywords: data.details.suspicious_keywords,
            domainAge: data.details.domain_age,
            grammarScore: data.details.grammar_score,
            legitimacyIndicators: data.details.legitimacy_indicators
        },
        timestamp: data.timestamp
    };
}

async function analyzeText(text) {
    const response = await fetch('/api/analyze-text', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text })
    });

    if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to analyze text');
    }

    const data = await response.json();
    return {
        url: data.url,
        text: data.text,
        scamProbability: data.scam_probability,
        isScam: data.is_scam,
        riskLevel: data.risk_level,
        details: {
            suspiciousKeywords: data.details.suspicious_keywords,
            sentimentScore: data.details.sentiment_score,
            grammarScore: data.details.grammar_score,
            readabilityScore: data.details.readability_score
        },
        timestamp: data.timestamp
    };
}

function displayResults(results) {
    const container = document.getElementById('resultsContainer');
    const section = document.getElementById('resultsSection');
    container.innerHTML = '';

    results.forEach(result => {
        const resultElement = createResultElement(result);
        container.appendChild(resultElement);
    });

    section.style.display = 'block';
    section.scrollIntoView({ behavior: 'smooth' });
}

function createResultElement(result) {
    const div = document.createElement('div');
    div.className = 'result-item';

    const riskClass = result.riskLevel === 'high' ? 'danger' :
                     result.riskLevel === 'medium' ? 'warning' : 'safe';
    const percentage = Math.round(result.scamProbability * 100);
    const localTime = new Date(result.timestamp).toLocaleString('en-LK', { timeZone: 'Asia/Colombo' });

    div.innerHTML = `
        <div class="result-header">
            <div class="result-url">${result.url || 'Text Analysis'}</div>
            <div class="probability-badge ${riskClass}">
                ${percentage}% Risk
            </div>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" style="width: ${percentage}%; background: ${
                result.riskLevel === 'high' ? '#dc3545' :
                result.riskLevel === 'medium' ? '#ffc107' : '#28a745'
            }"></div>
        </div>
        <div class="result-details">
            <strong>Risk Level:</strong> ${result.riskLevel?.toUpperCase() || '-'}<br>
            <strong>Suspicious Keywords:</strong> ${(result.details?.suspiciousKeywords || []).join(', ') || 'None detected'}<br>
            ${result.details?.domainAge ? `<strong>Domain Age:</strong> ${result.details.domainAge}<br>` : ''}
            <strong>Grammar Score:</strong> ${result.details?.grammarScore ?? '-'} / 100<br>
            <strong>Analysis Time:</strong> ${localTime}
        </div>
        <div class="feedback-row">
            <button class="btn btn-secondary btn-correct">‚úì Correct</button>
            <button class="btn btn-secondary btn-wrong">‚úó Wrong</button>
        </div>
    `;

    const btnCorrect = div.querySelector('.btn-correct');
    const btnWrong = div.querySelector('.btn-wrong');

    const payloadBase = {
        analysis_id: result.analysis_id || null,
        url: result.url || null,
        text_snippet: result.text ? String(result.text).slice(0, 200) : null,
        predicted_is_scam: !!result.isScam,
        user_note: null
    };

    btnCorrect.addEventListener('click', async () => {
        await sendFeedback({ ...payloadBase, is_correct: true });
        btnCorrect.disabled = btnWrong.disabled = true;
        showAlert('Thanks! Your feedback was recorded.', 'success');
    });

    btnWrong.addEventListener('click', async () => {
        await sendFeedback({ ...payloadBase, is_correct: false });
        btnCorrect.disabled = btnWrong.disabled = true;
        showAlert('Thanks! Your feedback was recorded.', 'success');
    });

    return div;
}

async function sendFeedback(payload) {
    try {
        const res = await fetch('/api/feedback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok || !data.success) {
            throw new Error(data.error || 'Failed to save feedback');
        }
        return data;
    } catch (err) {
        console.error('Feedback error:', err);
        showAlert('Could not save feedback. Please try again.', 'error');
    }
}

function updateStats(result) {
    analysisStats.totalChecked++;
    if (result.isScam) {
        analysisStats.scamsDetected++;
    } else {
        analysisStats.safeScholarships++;
    }
    updateStatsDisplay();
}

function updateStatsDisplay() {
    document.getElementById('totalChecked').textContent = analysisStats.totalChecked;
    document.getElementById('scamsDetected').textContent = analysisStats.scamsDetected;
    document.getElementById('safeScholarships').textContent = analysisStats.safeScholarships;
}

function loadStoredStats() {
    updateStatsDisplay();
}

function showAlert(message, type) {
    const alertId = type === 'success' ? 'successAlert' : 'errorAlert';
    const alert = document.getElementById(alertId);
    alert.textContent = message;
    alert.style.display = 'block';

    setTimeout(() => {
        alert.style.display = 'none';
    }, 5000);
}

function setLoadingState(button, isLoading) {
    if (isLoading) {
        button.disabled = true;
        button.textContent = 'Analyzing...';
    } else {
        button.disabled = false;
        button.textContent = button.id.includes('batch') ? 'Analyze All URLs' :
                            button.id.includes('text') ? 'Analyze Text' : 
                            button.id.includes('upload') ? 'Analyze Uploaded File' : 'Analyze Scholarship';
    }
}

function showLoading(show) {
    const loading = document.getElementById('loadingIndicator');
    loading.style.display = show ? 'block' : 'none';
}

function readFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = e => reject(new Error('Failed to read file'));
        reader.readAsText(file);
    });
}

async function loadAnalyticsCharts() {
    try {
        const res = await fetch('/api/statistics/extended');
        const data = await res.json();
        
        document.getElementById('accuracyRate').textContent = `${data.accuracy_rate}%`;

        // Calculate percentages for footer stats
        const total = data.scams_detected + data.safe_scholarships;
        const scamPercent = total > 0 ? Math.round((data.scams_detected / total) * 100) : 0;
        const safePercent = total > 0 ? Math.round((data.safe_scholarships / total) * 100) : 0;
        
        document.getElementById('scamPercentage').textContent = `${scamPercent}%`;
        document.getElementById('safePercentage').textContent = `${safePercent}%`;

        // Scam vs Safe Chart - Enhanced Doughnut
        new Chart(document.getElementById('scamChart'), {
            type: 'doughnut',
            data: {
                labels: ['Scams Detected', 'Safe Scholarships'],
                datasets: [{
                    label: 'Analysis Count',
                    data: [data.scams_detected, data.safe_scholarships],
                    backgroundColor: [
                        'rgba(220, 53, 69, 0.8)',
                        'rgba(40, 167, 69, 0.8)'
                    ],
                    borderColor: [
                        'rgba(220, 53, 69, 1)',
                        'rgba(40, 167, 69, 1)'
                    ],
                    borderWidth: 2,
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: {
                                size: 12,
                                weight: '600'
                            },
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${context.label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                cutout: '65%'
            }
        });

        // Accuracy trend - Enhanced Line Chart
        const labels = data.trend_data.map(item => 
            new Date(item.timestamp).toLocaleTimeString('en-LK', { 
                timeZone: 'Asia/Colombo',
                hour: '2-digit',
                minute: '2-digit'
            })
        );
        const points = data.trend_data.map(item => item.scam ? 1 : 0);
        
        // Calculate trend
        const avgRisk = points.length > 0 ? 
            Math.round((points.reduce((a, b) => a + b, 0) / points.length) * 100) : 0;
        document.getElementById('avgRisk').textContent = `${avgRisk}%`;
        
        const trendDirection = points.length > 1 && points[points.length - 1] > points[0] ? '‚Üó' : 
                              points.length > 1 && points[points.length - 1] < points[0] ? '‚Üò' : '‚Üí';
        document.getElementById('trendDirection').textContent = trendDirection;

        new Chart(document.getElementById('accuracyChart'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Risk Level',
                    data: points,
                    fill: true,
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderColor: 'rgba(0, 123, 255, 1)',
                    borderWidth: 3,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: 'rgba(0, 123, 255, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgba(0, 123, 255, 1)',
                    pointHoverBorderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: {
                                size: 12,
                                weight: '600'
                            },
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y === 1 ? 'Scam Detected' : 'Safe Scholarship';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 1,
                        ticks: {
                            stepSize: 1,
                            callback: function(value) {
                                return value === 1 ? 'Scam' : 'Safe';
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        // Domain distribution - Enhanced Pie Chart
        const domains = Object.keys(data.domain_distribution);
        const domainCounts = Object.values(data.domain_distribution);
        
        document.getElementById('uniqueDomains').textContent = domains.length;
        document.getElementById('topDomain').textContent = domains.length > 0 ? 
            domains[domainCounts.indexOf(Math.max(...domainCounts))] : '-';

        new Chart(document.getElementById('domainChart'), {
            type: 'pie',
            data: {
                labels: domains,
                datasets: [{
                    data: domainCounts,
                    backgroundColor: [
                        'rgba(0, 123, 255, 0.8)',
                        'rgba(220, 53, 69, 0.8)',
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(102, 16, 242, 0.8)',
                        'rgba(32, 201, 151, 0.8)'
                    ],
                    borderColor: '#fff',
                    borderWidth: 3,
                    hoverOffset: 15
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: {
                                size: 12,
                                weight: '600'
                            },
                            usePointStyle: true,
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        return {
                                            text: `${label} (${value})`,
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        callbacks: {
                            label: function(context) {
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${context.label}: ${value} analyses (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading analytics:', error);
    }
}

function generateColors(n) {
    const colors = ['#007bff', '#dc3545', '#ffc107', '#28a745', '#6610f2', '#20c997'];
    return Array.from({ length: n }, (_, i) => colors[i % colors.length]);
}

async function loadHistory() {
    try {
        const res = await fetch('/api/history');
        const data = await res.json();
        const container = document.getElementById('historyResults');
        
        if (data.results && data.results.length > 0) {
            container.innerHTML = data.results.map(r => `
                <div class="history-item">
                    <strong>${r.url || 'Text Entry'}</strong><br>
                    Scam: ${r.is_scam ? 'Yes' : 'No'}<br>
                    Probability: ${Math.round(r.scam_probability * 100)}%<br>
                    Time: ${new Date(r.timestamp).toLocaleString('en-LK', { timeZone: 'Asia/Colombo' })}
                </div>
            `).join('');
        } else {
            container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No analysis history yet</p>';
        }
    } catch (error) {
        console.error('Error loading history:', error);
    }
}

// Initialize everything on page load
document.addEventListener('DOMContentLoaded', () => {
    loadAnalyticsCharts();
    loadHistory();
});
</script>
</body>
</html>